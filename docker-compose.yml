services:
  mcp-rfp-server:
    build: .
    restart: unless-stopped
    env_file:
      - .env
    ports:
      - "8000:8000"
    volumes:
      # Core application volumes - always mounted
      - ./src:/app/src
      - ./outputs:/app/outputs
      - ./chroma_data:/app/chroma_data
      - ./scripts:/app/scripts

      # --- Volumes for Google Drive Authentication ---
      # Mount the credentials file (read-only for security)
      - ./credentials.json:/app/credentials.json:ro
      # Mount the token file to persist login across restarts
      - ./token.json:/app/token.json
      # -----------------------------------------------

    environment:
      # Core Configuration - Required
      - GOOGLE_API_KEY=${GOOGLE_API_KEY}
      - SERVER_NAME=mcp-rfp-server
      - LOG_LEVEL=${LOG_LEVEL:-INFO}
      - DEBUG=${DEBUG:-false}

      # Knowledge Source Configuration - "local", "sharepoint", or "gdrive"
      - KNOWLEDGE_SOURCE=${KNOWLEDGE_SOURCE:-gdrive}

      # SharePoint Configuration - Required when KNOWLEDGE_SOURCE=sharepoint
      - SHAREPOINT_TENANT_ID=${SHAREPOINT_TENANT_ID}
      - SHAREPOINT_CLIENT_ID=${SHAREPOINT_CLIENT_ID}
      - SHAREPOINT_CLIENT_SECRET=${SHAREPOINT_CLIENT_SECRET}
      - SHAREPOINT_SITE_URL=${SHAREPOINT_SITE_URL}
      - SHAREPOINT_FOLDER_PATH=${SHAREPOINT_FOLDER_PATH:-knowledge_base}

      # --- Google Drive Configuration - Required when KNOWLEDGE_SOURCE=gdrive ---
      - GDRIVE_KNOWLEDGE_BASE_FOLDER_ID=${GDRIVE_KNOWLEDGE_BASE_FOLDER_ID}
      # -------------------------------------------------------------------------

      # AI and Processing Configuration
      - GEMINI_MODEL=${GEMINI_MODEL:-gemini-1.5-flash-latest}
      - SPACY_MODEL=${SPACY_MODEL:-en_core_web_sm}
      - EMBEDDING_MODEL=${EMBEDDING_MODEL:-all-MiniLM-L6-v2}

      # Data Storage Paths (these are paths inside the container)
      - CHROMA_DB_PATH=/app/chroma_data
      - OUTPUT_PATH=/app/outputs
      - KNOWLEDGE_BASE_PATH=/app/knowledge_base

      # Processing Limits
      - MAX_DOCUMENT_SIZE_MB=${MAX_DOCUMENT_SIZE_MB:-50}
      - MAX_REQUIREMENTS_PER_DOCUMENT=${MAX_REQUIREMENTS_PER_DOCUMENT:-200}
      - MAX_CONCURRENT_REQUESTS=${MAX_CONCURRENT_REQUESTS:-10}
      - MAX_SEARCH_RESULTS=${MAX_SEARCH_RESULTS:-50}

      # Search and Analysis Parameters
      - DEFAULT_SEARCH_LIMIT=${DEFAULT_SEARCH_LIMIT:-5}
      - SIMILARITY_THRESHOLD=${SIMILARITY_THRESHOLD:-0.7}
      - CONFIDENCE_THRESHOLD=${CONFIDENCE_THRESHOLD:-0.6}

      # MCP Protocol Settings
      - MCP_PROTOCOL_VERSION=${MCP_PROTOCOL_VERSION:-2024-11-05}
      - ENABLE_MCP_LOGGING=${ENABLE_MCP_LOGGING:-true}

networks:
  rfp-network:
    driver: bridge